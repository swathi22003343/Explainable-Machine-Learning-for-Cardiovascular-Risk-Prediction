# -*- coding: utf-8 -*-
"""final year project - phase 2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1dkvY2syGPjvpXZD-KA8FqWXR9g5VK71c
"""

!pip install shap

import pandas as pd
# Load dataset
data = pd.read_csv("/content/heart-uci.csv")
# Display first 5 rows
data.head()

# Check dataset shape
data.shape

# Check column names and data types
data.info()

# Check for missing values
data.isnull().sum()

# Input features
X = data.drop("target", axis=1)

# Output label
y = data["target"]

from sklearn.model_selection import train_test_split

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

from sklearn.preprocessing import StandardScaler

scaler = StandardScaler()

X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

from sklearn.linear_model import LogisticRegression

# Initialize model
model = LogisticRegression(max_iter=1000)

# Train model
model.fit(X_train_scaled, y_train)

# Predict on test data
y_pred = model.predict(X_test_scaled)

from sklearn.metrics import accuracy_score, classification_report

# Accuracy
accuracy = accuracy_score(y_test, y_pred)
print("Accuracy:", accuracy)

# Detailed report
print(classification_report(y_test, y_pred))

import shap

# Create SHAP explainer
explainer = shap.LinearExplainer(model, X_train_scaled)

shap_values = explainer.shap_values(X_test_scaled)

shap.summary_plot(shap_values, X_test, feature_names=X.columns)

def predict_heart_risk(input_data):
    # Convert input to DataFrame
    input_df = pd.DataFrame([input_data])

    # Scale input using trained scaler
    input_scaled = scaler.transform(input_df)

    # Predict class
    prediction = model.predict(input_scaled)[0]

    # Predict probability
    probability = model.predict_proba(input_scaled)[0][1]

    return prediction, probability

# Sample patient data (real-time input simulation)
sample_patient = {
    "age": 55,
    "sex": 1,
    "cp": 2,
    "trestbps": 140,
    "chol": 240,
    "fbs": 0,
    "restecg": 1,
    "thalach": 150,
    "exang": 0,
    "oldpeak": 1.2,
    "slope": 1,
    "ca": 0,
    "thal": 2
}

result, risk_prob = predict_heart_risk(sample_patient)

print("Risk Prediction:", "High Risk" if result == 1 else "Low Risk")
print("Risk Probability:", round(risk_prob * 100, 2), "%")

# Create SHAP explainer using training data
explainer = shap.LinearExplainer(model, X_train_scaled)

def explain_prediction(input_data):
    input_df = pd.DataFrame([input_data])
    input_scaled = scaler.transform(input_df)

    # Get SHAP values
    shap_values = explainer.shap_values(input_scaled)

    # Create SHAP explanation plot
    shap.force_plot(
        explainer.expected_value,
        shap_values[0],
        input_df,
        matplotlib=True
    )

explain_prediction(sample_patient)

def risk_level(probability):
    if probability < 0.4:
        return "Low Risk"
    elif probability < 0.7:
        return "Medium Risk"
    else:
        return "High Risk"

print("Risk Level:", risk_level(risk_prob))

import numpy as np

def generate_reason(input_data, probability, shap_values):
    # Convert to DataFrame
    input_df = pd.DataFrame([input_data])

    # Get feature impact
    feature_impact = dict(zip(input_df.columns, shap_values))

    # Sort features by absolute impact
    sorted_features = sorted(
        feature_impact.items(),
        key=lambda x: abs(x[1]),
        reverse=True
    )

    # Top contributing factors
    top_factors = sorted_features[:3]

    # Risk level logic
    if probability < 0.4:
        reason = (
            "All major cardiovascular parameters such as blood pressure, "
            "cholesterol, heart rate, and ECG values are within normal ranges. "
            "No significant risk factors were detected."
        )

    elif probability < 0.7:
        reason = (
            f"A mild cardiovascular risk is observed mainly due to factors like "
            f"{top_factors[0][0]} and {top_factors[1][0]}, "
            "which slightly deviate from normal values. "
            "Regular monitoring and lifestyle improvement are recommended."
        )

    else:
        reason = (
            f"A high cardiovascular risk is identified primarily due to elevated "
            f"{top_factors[0][0]}, {top_factors[1][0]}, and {top_factors[2][0]}. "
            "These factors significantly increase the likelihood of heart-related issues "
            "and require medical attention."
        )

    return reason, top_factors

def final_prediction_output(input_data):
    # Prediction
    input_df = pd.DataFrame([input_data])
    input_scaled = scaler.transform(input_df)

    prediction = model.predict(input_scaled)[0]
    probability = model.predict_proba(input_scaled)[0][1]

    # SHAP values
    shap_vals = explainer.shap_values(input_scaled)[0]

    # Risk level
    risk = risk_level(probability)

    # Reason
    reason, top_factors = generate_reason(input_data, probability, shap_vals)

    # Display output
    print("Risk Status:", risk)
    print("Risk Probability:", round(probability * 100, 2), "%")
    print("Reason for Risk:")
    print(reason)

    print("\nKey Contributing Factors:")
    for factor, impact in top_factors:
        print(f"- {factor}")

final_prediction_output(sample_patient)

final_prediction_output(sample_patient)

def doctor_recommendation(risk):
    if risk == "Low Risk":
        return (
            "No immediate medical intervention is required. "
            "Maintain a healthy lifestyle with regular exercise, "
            "balanced diet, and periodic health checkups."
        )

    elif risk == "Medium Risk":
        return (
            "Moderate cardiovascular risk detected. "
            "Lifestyle modifications such as diet control, "
            "physical activity, and regular monitoring are recommended. "
            "Consultation with a healthcare professional is advised."
        )

    else:
        return (
            "High cardiovascular risk detected. "
            "Immediate medical consultation is strongly recommended. "
            "Further diagnostic tests and continuous monitoring may be required."
        )

def risk_color(risk):
    if risk == "Low Risk":
        return "GREEN"
    elif risk == "Medium Risk":
        return "YELLOW"
    else:
        return "RED"

def final_system_output(input_data):
    # Prepare input
    input_df = pd.DataFrame([input_data])
    input_scaled = scaler.transform(input_df)

    # Prediction
    probability = model.predict_proba(input_scaled)[0][1]
    risk = risk_level(probability)

    # SHAP explanation
    shap_vals = explainer.shap_values(input_scaled)[0]
    reason, top_factors = generate_reason(input_data, probability, shap_vals)

    # Recommendation
    recommendation = doctor_recommendation(risk)

    # Display results
    print("======================================")
    print("CARDIOVASCULAR RISK ASSESSMENT RESULT")
    print("======================================")

    print("\n1️⃣ Risk Status       :", risk)
    print("   Risk Indicator     :", risk_color(risk))

    print("\n2️⃣ Risk Probability  :", round(probability * 100, 2), "%")

    print("\n3️⃣ Reason for Risk   :")
    print(reason)

    print("\n4️⃣ Key Contributing Factors:")
    for factor, _ in top_factors:
        print(f"- {factor}")

    print("\n5️⃣ Medical Recommendation:")
    print(recommendation)

final_system_output(sample_patient)

# Mapping raw column names to human-friendly descriptions
feature_names_mapping = {
    "age": "Age",
    "sex": "Male sex (biological sex)",
    "cp": "Chest pain type",
    "trestbps": "Resting blood pressure",
    "chol": "Cholesterol level",
    "fbs": "Fasting blood sugar > 120 mg/dl",
    "restecg": "Resting ECG results",
    "thalach": "Maximum heart rate achieved",
    "exang": "Exercise induced angina",
    "oldpeak": "ST depression induced by exercise",
    "slope": "Slope of ST segment",
    "ca": "Number of major vessels colored by fluoroscopy",
    "thal": "Thalassemia status"
}

def generate_reason_human(input_data, probability, shap_values):
    input_df = pd.DataFrame([input_data])
    feature_impact = dict(zip(input_df.columns, shap_values))
    sorted_features = sorted(feature_impact.items(), key=lambda x: abs(x[1]), reverse=True)
    top_factors = sorted_features[:3]

    # Convert top factors to human-readable names
    top_factors_friendly = [feature_names_mapping[f[0]] for f in top_factors]

    if probability < 0.4:
        reason = (
            "All major cardiovascular parameters such as blood pressure, cholesterol, "
            "heart rate, ECG, and chest pain indicators are within normal ranges. "
            "No significant risk factors detected."
        )
    elif probability < 0.7:
        reason = (
            f"A mild cardiovascular risk is observed mainly due to {top_factors_friendly[0]} and {top_factors_friendly[1]}, "
            "which slightly deviate from normal values. Regular monitoring and lifestyle improvement are recommended."
        )
    else:
        reason = (
            f"A high cardiovascular risk is identified primarily due to {top_factors_friendly[0]}, "
            f"{top_factors_friendly[1]}, and {top_factors_friendly[2]}. "
            "These factors significantly increase the likelihood of heart-related issues and require medical attention."
        )

    return reason, top_factors_friendly

# Example usage
input_scaled = scaler.transform(pd.DataFrame([sample_patient]))
shap_vals = explainer.shap_values(input_scaled)[0]

reason, top_factors = generate_reason_human(sample_patient, model.predict_proba(input_scaled)[0][1], shap_vals)

print("Reason for Risk:")
print(reason)
print("Key Contributing Factors:")
print(top_factors)

import pickle

pickle.dump(model, open("heart_model.pkl", "wb"))
pickle.dump(scaler, open("scaler.pkl", "wb"))

print("Files saved successfully")
